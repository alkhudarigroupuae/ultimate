<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Ultimate Store</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <script>
        (function adminGate(){
            try {
                const KEY = 'isAdmin';
                if (localStorage.getItem(KEY) === 'true') return;
                const overlay = document.createElement('div');
                overlay.id = 'admin-gate';
                overlay.style.cssText = 'position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:9999;color:#fff;overflow:hidden;';
                overlay.innerHTML = '<div style="border:1px solid #333;padding:1.5rem;width:min(420px,90vw);background:#111;box-sizing:border-box;">'
                    + '<h3 style=\"margin:0 0 .75rem 0;\">Admin Access</h3>'
                    + '<input type=\"password\" id=\"admin-pass\" placeholder=\"Password\" style=\"width:100%;padding:.75rem;background:#000;border:1px solid #333;color:#fff;border-radius:0px;\">'
                    + '<button id=\"admin-login\" style=\"margin-top:.75rem;width:100%;padding:.75rem;background:#5D3FD3;color:#fff;border:none;border-radius:0px;cursor:pointer;transition:opacity .15s;\">Enter</button>'
                    + '<div id=\"admin-msg\" style=\"margin-top:.5rem;color:#aaa;font-size:.9rem;\"></div>'
                    + '</div>';
                document.addEventListener('DOMContentLoaded', () => document.body.appendChild(overlay));
                function verify(pass){ return pass === '2468'; }
                document.addEventListener('click', async (e) => {
                    if (e.target && e.target.id === 'admin-login') {
                        const pass = document.getElementById('admin-pass').value;
                        if (verify(pass)) {
                            localStorage.setItem(KEY, 'true');
                            document.getElementById('admin-gate')?.remove();
                        } else {
                            const msg = document.getElementById('admin-msg'); if (msg) msg.textContent = 'Wrong password';
                        }
                    }
                });
                document.addEventListener('mouseover', (e) => {
                    if (e.target && e.target.id === 'admin-login') e.target.style.opacity = '0.9';
                });
                document.addEventListener('mouseout', (e) => {
                    if (e.target && e.target.id === 'admin-login') e.target.style.opacity = '1';
                });
            } catch(_) {}
        })();
    </script>
    <header>
        <h1>Store Admin</h1>
        <nav>
            <a href="index.html">View Store</a>
            <a href="dashboard.html" style="color: var(--text-color);">Dashboard</a>
            <a href="#">Inventory</a>
            <a href="#">Orders</a>
        </nav>
    </header>

    <main>
        <div class="grid" style="margin-bottom: 3rem; grid-template-columns: repeat(4, 1fr);">
            <div class="card" style="padding: 1.5rem;">
                <div style="color: var(--secondary-text); font-size: 0.9rem;">Total Sales</div>
                <div style="font-size: 1.8rem; font-weight: 700; margin-top: 0.5rem;">8,920 SYP</div>
            </div>
            <div class="card" style="padding: 1.5rem;">
                <div style="color: var(--secondary-text); font-size: 0.9rem;">Orders Today</div>
                <div style="font-size: 1.8rem; font-weight: 700; margin-top: 0.5rem;">15</div>
            </div>
            <div class="card" style="padding: 1.5rem;">
                <div style="color: var(--secondary-text); font-size: 0.9rem;">Low Stock Items</div>
                <div style="font-size: 1.8rem; font-weight: 700; margin-top: 0.5rem; color: #ff4444;">3</div>
            </div>
            <div class="card" style="padding: 1.5rem;">
                <div style="color: var(--secondary-text); font-size: 0.9rem;">Total Customers</div>
                <div style="font-size: 1.8rem; font-weight: 700; margin-top: 0.5rem;">320</div>
            </div>
        </div>

        <!-- Hero Banner Settings -->
        <h2 style="margin-bottom: 1rem;">Website Hero Banner Settings</h2>
        <div class="card" style="margin-bottom: 3rem; padding: 2rem;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: var(--secondary-text);">Banner Title</label>
                        <input type="text" id="hero-title-input" style="width: 100%; padding: 0.8rem; background: #000; border: 1px solid #333; color: #fff; border-radius: 4px;" placeholder="Enter title...">
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: var(--secondary-text);">Banner Subtitle</label>
                        <input type="text" id="hero-subtitle-input" style="width: 100%; padding: 0.8rem; background: #000; border: 1px solid #333; color: #fff; border-radius: 4px;" placeholder="Enter subtitle...">
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: var(--secondary-text);">Banner Image URL</label>
                        <input type="text" id="hero-image-input" style="width: 100%; padding: 0.8rem; background: #000; border: 1px solid #333; color: #fff; border-radius: 4px;" placeholder="Enter image URL...">
                    </div>
                    <button onclick="saveHeroSettings()" style="background: var(--brand-color); color: #fff; border: none; padding: 0.8rem 2rem; border-radius: 4px; cursor: pointer; font-weight: 600;">Save Changes</button>
                    <p id="save-message" style="margin-top: 1rem; color: #0f0; display: none;">Settings saved successfully!</p>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--secondary-text);">Preview</label>
                    <div id="hero-preview" style="width: 100%; height: 250px; background-color: #000; background-size: cover; background-position: center; border-radius: 8px; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; border: 1px solid #333;">
                        <div style="background: rgba(0,0,0,0.5); padding: 1rem; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                            <h3 id="preview-title" style="font-size: 1.5rem; margin-bottom: 0.5rem; color: #fff;">Title</h3>
                            <p id="preview-subtitle" style="color: #ccc;">Subtitle</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <h2 style="margin-top:2rem;">Products Management</h2>
        <div class="card" style="padding:1.5rem; margin-bottom:2rem;">
            <div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:1rem;">
                <button class="btn" id="add-product" style="width:auto;">+ Add Product</button>
            </div>
            <div id="product-list" class="item-list" style="display:grid; gap:1rem;"></div>
        </div>

        <h2>Recent Orders</h2>
        <div class="card" style="background: transparent; border: none;">
            <table class="dashboard-table">
                <thead>
                    <tr>
                        <th>Order #</th>
                        <th>Customer</th>
                        <th>Items</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>#ST-4021</td>
                        <td>Hamza R.</td>
                        <td>1x Ultimate Hoodie - Black</td>
                        <td>120.00 SYP</td>
                        <td><span class="status-badge">Processing</span></td>
                        <td>10 mins ago</td>
                    </tr>
                    <tr>
                        <td>#ST-4020</td>
                        <td>Sarah J.</td>
                        <td>2x Water Bottle</td>
                        <td>120.00 SYP</td>
                        <td><span class="status-badge" style="background: #222; color: #888;">Shipped</span></td>
                        <td>2 hours ago</td>
                    </tr>
                    <tr>
                        <td>#ST-4019</td>
                        <td>Mike T.</td>
                        <td>1x Gym Bag</td>
                        <td>180.00 SYP</td>
                        <td><span class="status-badge" style="background: #222; color: #888;">Delivered</span></td>
                        <td>Yesterday</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>
    <script src="data.js"></script>
    <script>
        // Load settings
        const titleInput = document.getElementById('hero-title-input');
        const subtitleInput = document.getElementById('hero-subtitle-input');
        const imageInput = document.getElementById('hero-image-input');
        const previewTitle = document.getElementById('preview-title');
        const previewSubtitle = document.getElementById('preview-subtitle');
        const heroPreview = document.getElementById('hero-preview');
        const productList = document.getElementById('product-list');

        function loadSettings() {
            const savedHero = JSON.parse(localStorage.getItem('store_hero')) || (typeof defaultHero !== 'undefined' ? defaultHero : {
                title: "EQUIP YOUR GREATNESS",
                subtitle: "Premium Gear for the Ultimate Athlete",
                image: "https://images.unsplash.com/photo-1517836357463-d25dfeac3438?q=80&w=1470&auto=format&fit=crop"
            });

            titleInput.value = savedHero.title;
            subtitleInput.value = savedHero.subtitle;
            imageInput.value = savedHero.image;

            updatePreview();

            // Load products
            listAll = JSON.parse(localStorage.getItem('store_products')) || (typeof products !== 'undefined' ? products : []);
            renderProductsList();
        }

        function updatePreview() {
            previewTitle.textContent = titleInput.value;
            previewSubtitle.textContent = subtitleInput.value;
            heroPreview.style.backgroundImage = `url('${imageInput.value}')`;
        }

        function saveHeroSettings() {
            const newHero = {
                title: titleInput.value,
                subtitle: subtitleInput.value,
                image: imageInput.value
            };
            localStorage.setItem('store_hero', JSON.stringify(newHero));
            
            const msg = document.getElementById('save-message');
            msg.style.display = 'block';
            setTimeout(() => {
                msg.style.display = 'none';
            }, 3000);
            
            updatePreview();
        }

        // Products Management
        let listAll = [];
        function renderProductsList() {
            productList.innerHTML = '';
            listAll.forEach(p => {
                const row = document.createElement('div');
                row.className = 'item-card';
                row.style.display = 'grid';
                row.style.gridTemplateColumns = '80px 1fr auto';
                row.style.gap = '1rem';
                row.style.alignItems = 'center';
                row.innerHTML = `
                    <img src="${p.image}" class="item-img" style="width:80px;height:80px;object-fit:cover;border-radius:4px;border:1px solid #222;">
                    <div class="item-details">
                        <h3>${p.name}</h3>
                        <p>${p.price.toFixed(2)} SYP &middot; ${p.category}</p>
                    </div>
                    <div class="actions">
                        <button class="btn" data-edit="${p.id}" style="width:auto; background:#2196F3;">Edit</button>
                        <button class="btn" data-del="${p.id}" style="width:auto; background:#f44336;">Delete</button>
                    </div>
                `;
                productList.appendChild(row);
            });
            // Edit/Delete handlers
            productList.querySelectorAll('[data-edit]').forEach(b => b.addEventListener('click', () => openModal(parseInt(b.getAttribute('data-edit'),10))));
            productList.querySelectorAll('[data-del]').forEach(b => b.addEventListener('click', () => {
                const id = parseInt(b.getAttribute('data-del'),10);
                listAll = listAll.filter(x => x.id !== id);
                localStorage.setItem('store_products', JSON.stringify(listAll));
                renderProductsList();
            }));
        }

        // Edit/Add Modal
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'none';
        modal.style.position = 'fixed';
        modal.style.inset = '0';
        modal.style.background = 'rgba(0,0,0,0.8)';
        modal.style.zIndex = '3000';
        modal.innerHTML = `
            <div class="card" style="padding:1.5rem; max-width:520px; width:90%; margin:auto; margin-top:10vh; border:1px solid #333;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                    <h3 style="margin:0" id="md-title">Edit Product</h3>
                    <button id="md-close" class="btn" style="width:auto;background:#222;">Close</button>
                </div>
                <div style="display:grid; gap:.75rem;">
                    <input id="md-name" type="text" placeholder="Name" style="padding:.6rem;background:#000;border:1px solid #333;color:#fff;border-radius:4px;">
                    <input id="md-price" type="number" step="0.01" placeholder="Price" style="padding:.6rem;background:#000;border:1px solid #333;color:#fff;border-radius:4px;">
                    <input id="md-cat" type="text" placeholder="Category" style="padding:.6rem;background:#000;border:1px solid #333;color:#fff;border-radius:4px;">
                    <div>
                        <label style="display:block; margin-bottom:.25rem; color:#888;">Image</label>
                        <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
                            <img id="md-thumb" alt="" style="width:80px;height:80px;object-fit:cover;border:1px solid #333;">
                            <input id="md-image" type="text" style="display:none;">
                            <input type="file" id="md-file" accept="image/*" style="color:#ccc;">
                            <button class="btn" id="md-upload" style="width:auto;">Upload</button>
                            <div id="md-status" style="color:#aaa; font-size:.9rem;"></div>
                        </div>
                    </div>
                    <button id="md-save" class="btn" style="width:auto;">Save</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.querySelector('#md-close').addEventListener('click', () => modal.style.display = 'none');

        async function uploadToVercel(file) {
            const base = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? 'http://localhost:3001' : '';
            const resp = await fetch(base + '/api/blob-upload', {
                method: 'POST',
                headers: {
                    'x-filename': file.name,
                    'content-type': file.type || 'application/octet-stream'
                },
                body: file
            });
            if (!resp.ok) throw new Error('Upload failed');
            const data = await resp.json();
            return data.url;
        }

        modal.querySelector('#md-upload').addEventListener('click', async () => {
            const f = modal.querySelector('#md-file').files[0];
            const status = modal.querySelector('#md-status');
            if (!f) { status.textContent = 'Choose an image'; return; }
            if (f.size > 20 * 1024 * 1024) { status.textContent = 'File exceeds 20MB'; return; }
            status.textContent = 'Uploading...';
            try {
                const url = await uploadToVercel(f);
                modal.querySelector('#md-image').value = url;
                const th = modal.querySelector('#md-thumb'); if (th) th.src = url;
                status.textContent = 'Uploaded';
            } catch (e) {
                try {
                    const reader = new FileReader();
                    reader.onload = () => {
                        modal.querySelector('#md-image').value = reader.result || '';
                        const th = modal.querySelector('#md-thumb'); if (th) th.src = reader.result || '';
                        status.textContent = 'Using data URL';
                    };
                    reader.onerror = () => { status.textContent = 'Upload failed'; };
                    reader.readAsDataURL(f);
                } catch(_) {
                    status.textContent = 'Upload failed';
                }
            }
        });

        let editingId = null;
        function openModal(id) {
            editingId = id || null;
            const item = listAll.find(x => x.id === id) || { name:'', price:'', category:'', image:'' };
            modal.querySelector('#md-title').textContent = id ? 'Edit Product' : 'Add Product';
            modal.querySelector('#md-name').value = item.name || '';
            modal.querySelector('#md-price').value = item.price || '';
            modal.querySelector('#md-cat').value = item.category || '';
            modal.querySelector('#md-image').value = item.image || '';
            const th = modal.querySelector('#md-thumb'); if (th) th.src = item.image || '';
            modal.querySelector('#md-status').textContent = '';
            modal.style.display = 'block';
        }

        document.getElementById('add-product').addEventListener('click', () => openModal(null));
        modal.querySelector('#md-save').addEventListener('click', () => {
            const nm = modal.querySelector('#md-name').value.trim();
            const pr = parseFloat(modal.querySelector('#md-price').value);
            const ct = modal.querySelector('#md-cat').value.trim();
            const im = modal.querySelector('#md-image').value.trim();
            if (!nm || isNaN(pr) || !ct || !im) return alert('Fill all fields');
            if (editingId) {
                const idx = listAll.findIndex(x => x.id === editingId);
                if (idx !== -1) listAll[idx] = { ...listAll[idx], name: nm, price: pr, category: ct, image: im };
            } else {
                const nextId = (listAll.reduce((m, p) => Math.max(m, p.id || 0), 0) + 1) || 1;
                listAll.push({ id: nextId, name: nm, price: pr, category: ct, image: im });
            }
            localStorage.setItem('store_products', JSON.stringify(listAll));
            renderProductsList();
            modal.style.display = 'none';
        });

        // Add event listeners for live preview
        titleInput.addEventListener('input', updatePreview);
        subtitleInput.addEventListener('input', updatePreview);
        imageInput.addEventListener('input', updatePreview);

        // Initialize
        loadSettings();
    </script>
</body>
</html>
